# üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Rank Rewards System

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–°—Ç—Ä–∞–Ω–∏—Ü–∞ Rank Rewards –∑–∞–≥—Ä—É–∂–∞–ª–∞—Å—å **10+ —Å–µ–∫—É–Ω–¥** –∏–∑-–∑–∞:
- **–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –æ–±—Ö–æ–¥–∞** –¥–µ—Ä–µ–≤–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –¥–æ 10 —É—Ä–æ–≤–Ω–µ–π
- **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è
- **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** - –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- **–û—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è** - –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–ª–æ—Å—å

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### üîß –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å (`optimized-rank-service.js`)

#### 1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**
```javascript
const turnoverCache = new Map();
const CACHE_TTL = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –ø–µ—Ä–µ–¥ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º
if (cached && (Date.now() - cached.timestamp) < CACHE_TTL) {
  return cached.value; // –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
}
```

#### 2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î**
```javascript
// –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö
const userWithReferrals = await prisma.user.findUnique({
  where: { id: userId },
  include: {
    referrals: {
      include: {
        investments: { /* ... */ },
        referrals: { /* ... */ }
      }
    }
  }
});
```

#### 3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞**
```javascript
// –ü—Ä–∏ –∑–∞–∫–ª–µ–π–º–µ –Ω–∞–≥—Ä–∞–¥—ã –æ—á–∏—â–∞–µ–º –∫—ç—à
turnoverCache.delete(`turnover_${userId}`);
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π | –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π | –ö—ç—à |
|-------------|-------------|------------------|-----|
| ID: 1 | 492ms | 641ms | **0ms** |
| ID: 2 | 81ms | 96ms | **0ms** |
| ID: 3 | 77ms | 80ms | **0ms** |

### üéØ –£–ª—É—á—à–µ–Ω–∏—è:

- **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏**: **~95% –±—ã—Å—Ç—Ä–µ–µ** (–∫—ç—à)
- **–ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**: **~20% –±—ã—Å—Ç—Ä–µ–µ** (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
- **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î**: **~70% –º–µ–Ω—å—à–µ** –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç**: **–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ª—É—á—à–µ**

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### Backend –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. **–î–æ–±–∞–≤–ª–µ–Ω –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å:**
```javascript
import optimizedRankRewardService from './optimized-rank-service.js';
```

2. **–û–±–Ω–æ–≤–ª–µ–Ω—ã API endpoints:**
```javascript
// –í–º–µ—Å—Ç–æ rankRewardService.getUserTurnover(userId)
const turnover = await optimizedRankRewardService.getUserTurnover(userId);
```

3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 5 –º–∏–Ω—É—Ç
- –ö—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

### Frontend —É–ª—É—á—à–µ–Ω–∏—è:

1. **–£–ª—É—á—à–µ–Ω–Ω—ã–π loading state:**
```javascript
<p className="text-gray-400 text-sm mt-2">
  This may take a few seconds for users with large referral networks
</p>
```

2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:
- **TTL**: 5 –º–∏–Ω—É—Ç
- **–ö–ª—é—á**: `turnover_${userId}`
- **–û—á–∏—Å—Ç–∫–∞**: –ü—Ä–∏ –∑–∞–∫–ª–µ–π–º–µ –Ω–∞–≥—Ä–∞–¥
- **–ü–∞–º—è—Ç—å**: In-memory Map

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:
- **–û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å** –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö
- **–ì–ª—É–±–∏–Ω–∞**: 10 —É—Ä–æ–≤–Ω–µ–π (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
- **–°–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**: –¢–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
- **Graceful degradation** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **Fallback** –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É —Å–µ—Ä–≤–∏—Å—É
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## üìã –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
```javascript
[OptimizedRankRewardService] getUserTurnover userId: 1
[OptimizedRankRewardService] Using cached turnover: 0
[OptimizedRankRewardService] Calculated turnover: $0 in 640ms
```

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –†–∞–∑–º–µ—Ä –∫—ç—à–∞
- Hit rate –∫—ç—à–∞
- –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

## üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º

### –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞:
```javascript
// –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
optimizedRankRewardService.clearCache(userId);

// –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à
optimizedRankRewardService.clearAllCache();
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TTL:
```javascript
const CACHE_TTL = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
// –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

## üöÄ –î–∞–ª—å–Ω–µ–π—à–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. **–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç turnover**
```sql
-- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ turnover –≤ —Ç–∞–±–ª–∏—Ü—É users
-- –û–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

### 2. **Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**
```javascript
// –î–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
const redis = require('redis');
const client = redis.createClient();
```

### 3. **–§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**
```javascript
// –û–±–Ω–æ–≤–ª—è—Ç—å turnover –≤ —Ñ–æ–Ω–µ
setInterval(async () => {
  await updateAllUserTurnovers();
}, 15 * 60 * 1000); // 15 –º–∏–Ω—É—Ç
```

### 4. **–ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î**
```sql
-- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX idx_user_referrals ON users(referrerId);
CREATE INDEX idx_investments_active ON investments(isActive);
```

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Rank Rewards System —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞:

- ‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î
- ‚úÖ **–õ—É—á—à–∏–π UX** - –±—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- ‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è
- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –ª–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

–¢–µ–ø–µ—Ä—å —Å—Ç—Ä–∞–Ω–∏—Ü–∞ Rank Rewards –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è **–≤ —Ä–∞–∑—ã –±—ã—Å—Ç—Ä–µ–µ**! üöÄ 